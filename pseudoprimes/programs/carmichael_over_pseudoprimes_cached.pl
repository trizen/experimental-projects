#!/usr/bin/perl

# Carmichael numbers (A002997) that are also overpseudoprimes to base 2 (A141232).

# First terms of the sequence:
#   65700513721, 168003672409, 459814831561, 13685652197857, 34477679139751, 74031531351121, 92327722290241, 206175669172201, 704077371354601, 1882982959757929, 2901482064497017, 3715607011189609, 5516564718607489, 5636724028491697, 6137426373439681, 14987802403246609

# Let a(n) be the smallest Carmichael number with n prime factors that is also an overpseudoprime to base 2.

# a(3) = 65700513721
# a(4) <= 84286331493236478328609
# a(5) <= 3848515708338676403444146123852434164444641

# Note: all overpseudoprimes to base 2, are also super-pseudoprimes to base 2 (A050217).

# Subsequence of: A291637

# Inspired by:
#   https://oeis.org/A291637

use 5.020;
use strict;
use warnings;

use Storable;
use Math::GMPz;
use ntheory qw(:all);
use Math::Sidef qw(is_over_psp);
use Math::Prime::Util::GMP;
use experimental qw(signatures);

my $carmichael_file = "cache/factors-carmichael.storable";
my $super_psp_file  = "cache/factors-superpsp.storable";

my $carmichael = retrieve($carmichael_file);
my $super_psp  = retrieve($super_psp_file);

my %table;

foreach my $n (sort { $a <=> $b } map { Math::GMPz->new($_) } grep { exists $carmichael->{$_} } keys %$super_psp) {

    my @factors = split(' ', $super_psp->{$n});
    my $count   = scalar(@factors);

    next if ($count < 4);
    is_over_psp($n) || next;
    next if (exists $table{$count});

    $table{$count} = $n;
}

foreach my $count (sort { $a <=> $b } keys %table) {
    say "a($count) <= $table{$count}";
}

__END__

a(4) <= 84286331493236478328609
a(5) <= 3848515708338676403444146123852434164444641

# All terms < 2^64:

65700513721
168003672409
459814831561
13685652197857
34477679139751
74031531351121
92327722290241
206175669172201
704077371354601
1882982959757929
2901482064497017
3715607011189609
5516564718607489
5636724028491697
6137426373439681
14987802403246609
21992623472573953
37983770721011641
40407261656018041
45942556999692601
61207105212115201
68976886849817521
71181696666352897
73269524026756081
82367640349544881
96112112453637481
124110623325759001
136922877901053721
138730263089211949
149121391824105121
157819003352904169
215453244139615441
267307161661264873
303023416274704009
454335933458504953
467480206902847321
650831263414299001
686756168891991001
702843777477384649
764430984099213601
822682199613026521
838850966552611921
842430951097045633
897899614325144551
910903470908946769
999987515379253441
1318104490222560769
1361059733056788649
1366520251157221441
1415245842200291713
1422190326611289601
1470022979558080921
1489685301469898821
1588817901773059129
1591214073237951121
1621491474983069881
1670980503065714821
1730915239827538729
1736579734635802249
2042335720781118181
2074812251177850913
2100060348546462121
2124799919796109249
2165852849668004521
2167608269747502401
2290602125085734809
2300109468302827633
2433956302514248513
2777312304334204561
2866038138212933041
3045587102580976201
3366837255450971761
3373955068159272169
3475323715200662473
3548613855787878529
3616416821454341521
3810521847623599681
3852520757715800017
4124011961201272489
4301455387659369769
4756318888954526521
4787590240745244001
4817383633980720721
5493304789418799181
5746922560384346641
6873352230221035441
7363585030711557649
7503744980929584169
8484644588559219361
8712905394743722621
9336114239612065921
9607334349544074361
11361547313276985001
11485271162921629009
12353015546489239129
12506240087170964401
13511565474583100671
13711345850486182361
13941017269335208081
16262129395207852561
18306036175212817921
18414495019735773841

# Terms larger than 2^64 with 4 or more prime factors:

84286331493236478328609
238785721672990932002636641
652162324135615141105247041
24093635618510843745257459857
70201340991569558116402968001
227771286623746431430565559601
364543837598620783648982405593
379761920988045627933452831281
587842501908060265498668978001
852094992418367767673138945281
1368694721729290496203016089633
2002635347236414389575345940001
2437443916983976622621799865681
3167470077082470185005786098433
5505702247696344017805924008641
10391807355519825575323215933457
13382452004298186715268710384801
21302371512974194634310008508001
26662226078360163563063587743553
44628724197148881681527707058401
66881583662363279305861165297129
76994618157758554556569340572801
394011632924304519812069864833633
412192953065970422677464231121921
2571469406672422379523774505676353
13693039264673849279947083464462401
14549166520423641138258158455740961
39734073355969068474918050912842561
7191423162458599875951078367188613921
26408027130092288950663253754042930433
1095263819118696847793356614529265038561
3848515708338676403444146123852434164444641
26443753597988302064741975018501215395754317777669534195294433
