#!/usr/bin/perl

# Carmichael numbers with large Lehmar index: (n-1) / phi(n).

# See also:
#   "A note on Lehmer's Totient Problem" by Richard G.E. Pinch

use 5.020;
use strict;
use warnings;
use experimental qw(signatures);

use Storable;
use POSIX qw(ULONG_MAX);

use Math::GMPz;
use Math::GMPq;
use Math::MPFR;

use ntheory qw(:all);
use Math::Prime::Util::GMP;
use experimental qw(signatures);

my $carmichael_file = "cache/factors-carmichael.storable";
my $carmichael      = retrieve($carmichael_file);

#<<<
#~ sub my_euler_phi ($factors) {    # assumes n is squarefree
    #~ Math::GMPz->new(
              #~ Math::Prime::Util::GMP::vecprod(map { ($_ < ~0) ? ($_ - 1) : Math::Prime::Util::GMP::subint($_, 1) } @$factors));
#~ }
#>>>

sub my_euler_phi ($factors) {    # assumes n is squarefree

    state $t = Math::GMPz::Rmpz_init();
    state $u = Math::GMPz::Rmpz_init();

    Math::GMPz::Rmpz_set_ui($t, 1);

    foreach my $p (@$factors) {
        if ($p < ULONG_MAX) {
            Math::GMPz::Rmpz_mul_ui($t, $t, $p - 1);
        }
        else {
            Math::GMPz::Rmpz_set_str($u, $p, 10);
            Math::GMPz::Rmpz_sub_ui($u, $u, 1);
            Math::GMPz::Rmpz_mul($t, $t, $u);
        }
    }

    return $t;
}

my $q = Math::GMPq->new(0);
my $f = Math::MPFR->new(0);

my @results;

while (my ($key, $value) = each %$carmichael) {

    my @factors = split(' ', $value);

    scalar(@factors) >= 9 or next;

    #$factors[-1] < ~0 or next;

    my $phi = my_euler_phi(\@factors);

    Math::GMPq::Rmpq_set_str($q, Math::Prime::Util::GMP::subint($key, 1), 10);
    Math::GMPq::Rmpq_set_den($q, $phi);
    Math::GMPq::Rmpq_canonicalize($q);    # n is a cyclic number, therefore gcd(n,phi(n)) = 1

    Math::MPFR::Rmpfr_set_q($f, $q, 0);

    #if (Math::MPFR::Rmpfr_cmp_d($f, 2) > 0) {
    if (Math::MPFR::Rmpfr_cmp_d($f, 2.3) > 0) {
        push @results, [Math::MPFR::Rmpfr_get_d($f, 0), $key];
    }
}

@results = sort { ($a->[0] <=> $b->[0]) || (length($a->[1]) <=> length($b->[1])) || ($a->[1] cmp $b->[1]) } @results;

foreach my $r (@results) {
    printf("%.4f Lehmer index: %s\n", $r->[0], $r->[1]);
}

__END__

# Carmichael numbers with Lehmer index greater than 2.3:

2.3003 Lehmer index: 382314270322310985139418831028955559235551077239363319937510690579825910692881422216705
2.3003 Lehmer index: 102516344707172884851142791438256222991104300824835469404525203372610817210503885680644868610801665
2.3003 Lehmer index: 4412823034313496563108973287424449741444649232413929775135598042725475197356203078898797387942137986429776582959105
2.3003 Lehmer index: 17115578147839669320846011663408247767639003359102729698349780734829657127262721818787480284841785633531732841693185
2.3003 Lehmer index: 130178279512248145689998887824594049115047596365908573120027568752590640293039694708106232444932328701299653789446145
2.3003 Lehmer index: 842374402138793460532480082738612433309334772005285300922547056450028284072726356165976450955536340077977839169286145
2.3003 Lehmer index: 960064811402830073810200100198153971297440727779692305191913401792029854707319576971889504564413652957973909303304705
2.3003 Lehmer index: 1605655174994208968647068226039002868454943672262669133464570884881165205143838652604559021871828125010843819271312385
2.3003 Lehmer index: 2298107895011498759213822342102907139021808717798859128416663093691190533436410948051199171191516241998030918772383745
2.3003 Lehmer index: 95690701824263042186202551834599302099264869567040900224285784565081124379962106150065559686972470964546577580545
2.3003 Lehmer index: 8356786370174171364272539628260086158812099881758367252670669063507888534352081314043725342052409819583377219585
2.3003 Lehmer index: 109957715397129738027968126245051603528552224980035527305691206890963525323750356912296225440506028746436675585
2.3003 Lehmer index: 871641987741202829841080840884515081430035017061551479912391581493427449251698059038605943019265
2.3005 Lehmer index: 260349946905396900671119543882338184521094086965438750470975350786567337602945
2.3005 Lehmer index: 527620633110403414407362101794334931391181902106466731856196826355219609248311450535546681531905
2.3010 Lehmer index: 54772208597990407430395018479557528859948250022718336556935666676225482342335045521290671839328385
2.3013 Lehmer index: 2853450403236152332571821875265293508017495635204070217869999840422343584089739265
2.3013 Lehmer index: 3357733710606940815442482152032800055516213520001866203114341784330574852231168617711468545
2.3013 Lehmer index: 63218204316163844110039193928486460280561728562733798361958253146580410658230491422132612190237097985
2.3017 Lehmer index: 14701083488299057530174696885922722686956286485260401577115414785
2.3017 Lehmer index: 17452300933431977341377411415426424100747047988083074846070440152980711924826733435806521000332008808827544065
2.3017 Lehmer index: 115338868112289090549048233933544262758635325288220245236446935298362758813855609396077793425852036533906285963976898361345
2.3020 Lehmer index: 265254290756066930358119577715591455268521886989391944998212913199131074729078785
2.3020 Lehmer index: 11815272804203625491728591236897575202685891672371376175492339132222921929276566821874370637723154673426993665
2.3020 Lehmer index: 546231056648299309945879864873067527148520665055555595450356965014516409862017473033401345
2.3021 Lehmer index: 61751285336040585295804391670071058142224865543324607243406589162503580666870926270465
2.3021 Lehmer index: 72664438888083820643819682976576299583820992006550380566219911049269157831865133237087695622145
2.3023 Lehmer index: 10314769048017202862487190022261078137366617506364556874576731255559303133731265345
2.3023 Lehmer index: 2115053928659454900366521681477998704291584910057880016142690827403243490595613834706131314989356651334766414955820215536496688268751661057073811192705
2.3029 Lehmer index: 37839385943068863406967633413004957540054532539686888463944906014566240419460804270776358938980032660929917901837033235462145
2.3029 Lehmer index: 77921634020287997200599818673275408550456503578432198979868015119378470768178479816088971759820118556438222249261837640526049815870465
2.3039 Lehmer index: 772459017179480479061611372132330246001039753130436193419524315193543873326133868681083905
2.3066 Lehmer index: 8207559361488485717914083466116373717264699371724582710877145840690866238555017816065
2.3066 Lehmer index: 321030150905393790929751720043602006651739765349595158023943724894346115208705
2.3066 Lehmer index: 609474149754307571228516754200271950361864019582049946850331634081905311691255456707533875984385
2.3066 Lehmer index: 7984874852336870084046152942870205290072487411070132040375241455895037333018593644731780801801131397510735604256378184860460114637230819252957185
2.3066 Lehmer index: 87442364507941064290389420877371618131583809638629015974149269183503038553734204941447050779189712492167229051781019435426536531604721611677598813185
2.3066 Lehmer index: 723510542124555012090083865199600086232174786913103649509986726046626565417111116021892844545
2.3066 Lehmer index: 34470538975962764526754457116181986975826575285667670547352293994767489855961315844474665985
2.3066 Lehmer index: 4023276395177305347415511460225298062796974675462141180597533043338425565899660963640770751394800435023599105
2.3066 Lehmer index: 769172511870849796253861716399542738516967204481181784267093480870499805018462830755311257650146667644268333635198465
2.3066 Lehmer index: 25908863630396664820690592696745883472302215459780057182046034797105032292341436149378509381770667044898305
2.3066 Lehmer index: 2219369513930461038686397245711097315022440029049430530493434841610470231287061362182145
2.3066 Lehmer index: 369139570508370858855854305725521211702174215122552290694919454562966623007613857601851735306601265523515073064331288080362558100260462765384971876037787228048385
2.3066 Lehmer index: 61372441497323670446623766914847705250104121305600853994877052461628649603145962092155011665219585
2.3141 Lehmer index: 41604760897693331902470165821292362461433951708063322154567188228941668682983586385358489704603458398732060344251877309069575573157372480292819346023961831997147106037750301707265
