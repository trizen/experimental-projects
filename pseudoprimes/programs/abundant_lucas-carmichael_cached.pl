#!/usr/bin/perl

# a(n) = smallest pseudoprime to base 2 with n prime factors.
# https://oeis.org/A007011

use 5.020;
use strict;
use warnings;

use Storable;
use Math::GMPz;
use ntheory qw(:all);
use Math::Prime::Util::GMP;
use experimental qw(signatures);
use POSIX qw(ULONG_MAX);

my $storable_file = "cache/factors-lucas-carmichael.storable";
my $lucas_carmichael    = retrieve($storable_file);

sub my_sigma ($factors) { # assumes n is squarefree

    state $t = Math::GMPz::Rmpz_init();
    state $u = Math::GMPz::Rmpz_init();

    Math::GMPz::Rmpz_set_ui($t, 1);

    foreach my $p (@$factors) {
        if ($p < ULONG_MAX) {
            Math::GMPz::Rmpz_mul_ui($t, $t, $p + 1);
        }
        else {
            Math::GMPz::Rmpz_set_str($u, $p, 10);
            Math::GMPz::Rmpz_add_ui($u, $u, 1);
            Math::GMPz::Rmpz_mul($t, $t, $u);
        }
    }

    return $t;
}

use Math::MPFR;
my $t = Math::GMPz::Rmpz_init();

while (my ($key, $value) = each %$lucas_carmichael) {

    Math::Prime::Util::GMP::modint($key, 5) == 0
      or Math::Prime::Util::GMP::modint($key, 3) == 0
      or Math::Prime::Util::GMP::modint($key, 7) == 0
      or next;

    my @factors = split(' ', $value);

    Math::GMPz::Rmpz_set_str($t, $key, 10);
    my $abundancy = Math::MPFR->new(my_sigma(\@factors)) / $t;

    if ($abundancy >= 1.9) {
        printf("%.3f %s\n", $abundancy, $key);
    }

    #~ Math::GMPz::Rmpz_set_str($t, $key, 10);
    #~ Math::GMPz::Rmpz_mul_2exp($t, $t, 1);

    #~ if (my_sigma(\@factors) >= $t) {
        #~ say $key;
    #~ }
}

__END__

# Abundant Lucas-Carmichael numbers:

1252458644660264955837817577779489039780648512945893109814633472020085149868079698531417855
2594145124305120505650019954091626919606128354602761434556536080738401442000096118992495759705889535
7503803011401945390313632567155889317779849241720023200027377912291874770675496211600534991823238932817662007679615
1468886623107594191985089259487454023529927338735335871572144088372126718224237406387346265930975252826018335276025855
708080286040276247573286941132496454792845945227519230454772138306364190797749566971480367828250926380825710177519370626970837428019203359615
237782614965505765652388454391107081322923408716826394289483123293198561538881475627935642407850808058984976200132206676136969450491217966920720734729849215
71170318191681802908201833464802802569007083683469926541097483005021352441781809048362095475301157532447789502621780642082564311963798767545977494302795743341193478655
2136121975454165611873039026801263844635407890196626321436053620072639603163682986522017275442767284155330641168457219432918630844733426447357701507094694488736790222335
62204465720172726607845388078220007465731660555634304575600763947402648711114238381352103610031921939045731363333517882021981105579879055491810647749043815412290384749372112070655
60269674625477722588328759178306405054241442923209669607306532903478729504955756682565401469600942373139641181375332064438580532445894065443349509778322147208887582864167834007258495
115485452918780711151142429848020531057643025526618096144101358834408451288758160843098511117297067549979649552172961672257346135984598966006092805213232501970407871769382633756531802495
30936167096013568339773976047978340648756206742106115494596280619371357021828349849897704669900915935892729686111634980705476018793593906185914516587044915289319632401970797232705212736811698133366655
460904006056686426887303849334911434365320374753443778612928069139740807299223897362251200121979223985201992131540581322922430436263834889072617722535515257096631290414859505532710437375649860660512051091130670806208295840255
43825803010805233016544082034170578092422643088780601042660448508280269372251507615859531178468504974683716187916880294943395647298723610076531184486834546019684360060759169508052443004142751627078744327898523272155117785465601535
49093820569242497421539735961631215470145358790391203917681900937535026291790026661017013155301909736845388732080374143102912127113685479415926049857094468330973122146382877905568276561233378906017140098983924720938104860386708196203616895
