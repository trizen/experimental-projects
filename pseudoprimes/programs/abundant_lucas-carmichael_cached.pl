#!/usr/bin/perl

# a(n) = smallest pseudoprime to base 2 with n prime factors.
# https://oeis.org/A007011

use 5.020;
use strict;
use warnings;

use Storable;
use Math::GMPz;
use ntheory qw(:all);
use Math::Prime::Util::GMP;
use experimental qw(signatures);
use POSIX qw(ULONG_MAX);
use Math::MPFR;

my $storable_file = "cache/factors-lucas-carmichael.storable";
my $lucas_carmichael    = retrieve($storable_file);

sub my_sigma ($factors) { # assumes n is squarefree

    state $t = Math::GMPz::Rmpz_init();
    state $u = Math::GMPz::Rmpz_init();

    Math::GMPz::Rmpz_set_ui($t, 1);

    foreach my $p (@$factors) {
        if ($p < ULONG_MAX) {
            Math::GMPz::Rmpz_mul_ui($t, $t, $p + 1);
        }
        else {
            Math::GMPz::Rmpz_set_str($u, $p, 10);
            Math::GMPz::Rmpz_add_ui($u, $u, 1);
            Math::GMPz::Rmpz_mul($t, $t, $u);
        }
    }

    return $t;
}

my $t = Math::GMPz::Rmpz_init();

while (my ($key, $value) = each %$lucas_carmichael) {

    Math::Prime::Util::GMP::modint($key, 5) == 0
      or Math::Prime::Util::GMP::modint($key, 3) == 0
      or Math::Prime::Util::GMP::modint($key, 7) == 0
      or next;

    my @factors = split(' ', $value);

    Math::GMPz::Rmpz_set_str($t, $key, 10);
    my $abundancy = Math::MPFR->new(my_sigma(\@factors)) / $t;

    if ($abundancy >= 1.9) {
        my $s = sprintf("%.3f", $abundancy);
        if ($s == 2 and $abundancy < 2) {
            $s = "1.999";
        }
        printf("%s %s\n", $s, $key);
    }

    #~ Math::GMPz::Rmpz_set_str($t, $key, 10);
    #~ Math::GMPz::Rmpz_mul_2exp($t, $t, 1);

    #~ if (my_sigma(\@factors) >= $t) {
        #~ say $key;
    #~ }
}

__END__

# Abundant Lucas-Carmichael numbers:

1012591408428327888883952080728349448745451794025524955777432246705535
1252458644660264955837817577779489039780648512945893109814633472020085149868079698531417855
3525640083071359426950533598254613122919896092061877251620590307879239602990387932743281143295
1052449257995808516558772060796508547564702317190237996448835400978907896322445314841067306780415
2594145124305120505650019954091626919606128354602761434556536080738401442000096118992495759705889535
317563585230674118003618828350830251555421989549256372758646335221098241354334813230269344017811664302335
307322174499281982330271601186634282113080388101792969637125665253165770768035314406511873589376099654234495
7503803011401945390313632567155889317779849241720023200027377912291874770675496211600534991823238932817662007679615
1468886623107594191985089259487454023529927338735335871572144088372126718224237406387346265930975252826018335276025855
377080535536276592253796423176443032560980777230031484946338188720056863782039214209739994210096581248220715568530843942655
38269837134780176955108451814138295025392216034979454453555346572879900055568806315893941105962562908131723112113415782793006630655
708080286040276247573286941132496454792845945227519230454772138306364190797749566971480367828250926380825710177519370626970837428019203359615
48004480252852051285646070549127157890047486834077474187570451588852311338015732768562351620886252940556400392906811824917925622572444790546815
17933607380776953547401494506279782365552194507785521942884591097730529322356275937515746759628772146765603557839325724254335476932420638490668415
237782614965505765652388454391107081322923408716826394289483123293198561538881475627935642407850808058984976200132206676136969450491217966920720734729849215
27464378274128006514345068856535084247383796725617659211180883163979692012912796031841215269154793788548943432008945524745140822314236490983182185325143961465855
71170318191681802908201833464802802569007083683469926541097483005021352441781809048362095475301157532447789502621780642082564311963798767545977494302795743341193478655
2136121975454165611873039026801263844635407890196626321436053620072639603163682986522017275442767284155330641168457219432918630844733426447357701507094694488736790222335
787222305052394997724945516547365754011662300885413176469622073745477582640035495534105574008781335434719275080742355938058765385165632993837533689399387050916367220851560972415
62204465720172726607845388078220007465731660555634304575600763947402648711114238381352103610031921939045731363333517882021981105579879055491810647749043815412290384749372112070655
60269674625477722588328759178306405054241442923209669607306532903478729504955756682565401469600942373139641181375332064438580532445894065443349509778322147208887582864167834007258495
115485452918780711151142429848020531057643025526618096144101358834408451288758160843098511117297067549979649552172961672257346135984598966006092805213232501970407871769382633756531802495
2942025530897847303059161553127696713836422631991047280018992141639957231266992782899028741338169414312509581365432910371840336199601153489104075471660329480470470729156665358667312099455
145341839823538118589908940737089008244918217600245448152926415496883873367510744550924915919997615431767890445581676616890202279831691259121047263902991465683564018891177610818644889492095
30936167096013568339773976047978340648756206742106115494596280619371357021828349849897704669900915935892729686111634980705476018793593906185914516587044915289319632401970797232705212736811698133366655
372744321825508917589825780622269559207106151696761261456904829356364259901485259336473661995305966297639832265284800660006690320546498396301028774198385455766099865816051904623385725836354290482015615
4243956145856691488649853257507752819688291234668900526510245226244046303029023140365005594780869266038877254779170094433214125500034880034788337143123466118709589433100759366733846879733583731659951615
67036499387324497796155974605642471716635418200373323301576807225369370315312232029559032523487129671535586297421756953713123091684013481812885284843941358374196021224408282294478213444661587221100918015
7005574242102373354265832619421591501498581348426752216767036248226680037401546168161301314227636581438008139433458859307805227873100196476026293677677879531759791319113801558809031601549479001610956397055
1694262560759953154526670348772907540796170513663501032910914159595638310756094357081473065962067590116463265237063341299898280745740931429151682087763596885768443007124275790061776060783308671770836665700299939287935
1120416428168792738913288328714108075486596731609500545277404161754024902457216989103636273073839624409271473732654088529349478546697842940188727574450221416527231767306447775225485495497262801144338725957373407467404701055
460904006056686426887303849334911434365320374753443778612928069139740807299223897362251200121979223985201992131540581322922430436263834889072617722535515257096631290414859505532710437375649860660512051091130670806208295840255
128442365531799064156139510576495802513612486529333847930761533581974291983374969725354207967087368374177434310907963276692898670021010491481656390714055478242018340424490294608743427277513498508995462541550370517316566679757695
43825803010805233016544082034170578092422643088780601042660448508280269372251507615859531178468504974683716187916880294943395647298723610076531184486834546019684360060759169508052443004142751627078744327898523272155117785465601535
49093820569242497421539735961631215470145358790391203917681900937535026291790026661017013155301909736845388732080374143102912127113685479415926049857094468330973122146382877905568276561233378906017140098983924720938104860386708196203616895
